name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy Admin (Dashboard)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /www/wwwroot/ag.aura3333
            
            git checkout .
            git pull origin main
            
            cd dashboard
            echo "VITE_IS_LOCAL=false" > .env
            npm install --legacy-peer-deps && npm run build
            cd ../backend
            npm install --legacy-peer-deps
            pm2 restart agaura444 || pm2 start server.js --name agaura444

      - name: Deploy Client
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /www/wwwroot/aura3333
            
            git checkout .
            git pull origin main
            
            cd client
            echo "VITE_IS_LOCAL=false" > .env
            npm install --legacy-peer-deps && npm run build
            cd ../backend
            npm install --legacy-peer-deps
            pm2 restart aura444 || pm2 start server.js --name aura444

      - name: Notify Success
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="✅ Deployed successfully on VPS
          Commit: ${{ github.sha }}
          By: ${{ github.actor }}"

      - name: Notify Failure
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="❌ Deployment FAILED
          Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
